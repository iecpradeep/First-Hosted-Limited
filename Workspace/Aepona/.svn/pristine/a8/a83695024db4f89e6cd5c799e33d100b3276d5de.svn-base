/*******************************************************
 * Name:		Aepona PR Release 2
 * Script Type:	User Event
 * Version:		1.0.0
 * Version:		1.0.1 - 26 April 2013 - Amended -changed user role for the reject button - SA
 * Version:		1.0.2 - 29 April 2013 - Amended - Reject button should appear for the next approver (for the supervisor) - SA
 * Version:		1.0.3 - 30 April 2013 - Amended - Added Approve window which is link to the suitelet and that will update the approval note field (only for first approver  and second approver) - SA
 * Version:		1.0.4 - 30 April 2013 - Amended - show print and fax button only to the Belfast AP roles and as per send method specified in the PR. - SA
 * Date:		25 March 2013
 * Author:		FHL
 *******************************************************/



/**
 * @param type
 * @returns {Boolean}
 */
function calculateUSD(type)
{
	if (type == 'create' || type == 'edit') 
	{
		//Obtain a handle to the newly created PO
		var poRecord = nlapiGetNewRecord();
		var poRecordId = poRecord.getId();

		var currency = poRecord.getFieldValue('currency');
		var total = parseFloat(poRecord.getFieldValue('total'));
		var fxrate = 1.00;

		// target currency of 1 = USD.  No date specified so use current date.
		fxrate = parseFloat(nlapiExchangeRate(currency,1));

		var totalusd = total * fxrate;

		nlapiSubmitField('purchaseorder',poRecordId,'custbody_prusdfxrate',fxrate.toFixed(3),false);
		nlapiSubmitField('purchaseorder',poRecordId,'custbody_prtotalusd',totalusd.toFixed(2),false);
	} //if

	return true;
} //function


/**
 * @param type
 * @param form
 * @param request
 * @returns {Boolean}
 * 
 * 1.0.1 - Reject button should appear only for Aeopona company accountant role (id 1008)
 * 1.0.4 show print and fax button only to the belfast AP roles 
 */
function beforeLoad(type,form,request)
{
	// remove additional fields 

	try
	{
		var vendorNameColumn = nlapiGetLineItemField('item', 'vendorname');
		if (vendorNameColumn) vendorNameColumn.setDisplayType('hidden');

		var taxTotalField = nlapiGetField('taxtotal');
		if (taxTotalField) taxTotalField.setDisplayType('hidden');

		var subTotalField = nlapiGetField('subtotal');
		if (subTotalField) subTotalField.setDisplayType('hidden');

		var totalField = nlapiGetField('total');
		if (totalField) totalField.setDisplayType('hidden');

		//Get the button before relabeling or disabling
		var copyButton = form.getButton('autofill');
		var altcopyButton = form.getButton('secondaryautofill');
		var gotoregisterButton = form.getButton('gotoregister');

		var newButton = form.getButton('new');
		var historyButton = form.getButton('activityhistory');
		var emailButton = form.getButton('email');

		//Disable the button in the UI
		if (copyButton) copyButton.setVisible(false);
		if (altcopyButton) altcopyButton.setVisible(false);
		if (gotoregisterButton) gotoregisterButton.setVisible(false);
		if (newButton) newButton.setVisible(false);
		if (historyButton) historyButton.setVisible(false);
		if (emailButton) emailButton.setVisible(false);


		var context = nlapiGetContext();
		var UserDeptID = context.getRole();

		var user = context.getUser();
		var poRecord = nlapiGetNewRecord();
		var recordId = nlapiGetRecordId();
		var status = poRecord.getFieldValue('status');
		var stage = poRecord.getFieldValue('custbody_pr_approvalstage');
		// PO issue method (e.g email, fax, hard copy)
		var issueVia = poRecord.getFieldValue('custbody_suppliersendmethod');

		var nextApprover = poRecord.getFieldValue('nextapprover');

		var printButton = form.getButton('print');
		var faxButton = form.getButton('fax');

		if (printButton) printButton.setVisible(false);
		if (faxButton) faxButton.setVisible(false);
		
		// 1.0.4 show print and fax button only to the belfast AP roles   
		if((UserDeptID == '1000') && (UserDeptID == '1002'))
		{				
			// issue via fax
			if (issueVia == '2' )
			{
				if (faxButton) faxButton.setVisible(true);
			}
			
			// issue via print
			if (issueVia == '1' )
			{
				if (printButton) printButton.setVisible(true);
			}
			
		}

		var nextapproverfield = form.getField('nextapprover');
		if (nextapproverfield) nextapproverfield.setDisplayType('hidden');


		//add reject button if record is pending accounting approval ||pending supervisor approval
		// 1.0.1 - Reject button should appear only for Aeopona company accountant role (id 1008)
		//  i.e approval stage = "pending supervisor approval" (3))
		if ((stage == '1' && (UserDeptID == '1008')) ||(stage == '1' && (UserDeptID == '1000')) ||(stage == '3' && ( user == nextApprover)))
		{

			//var rejectLink = '"https://system.sandbox.netsuite.com/app/site/hosting/scriptlet.nl?script=111&deploy=1&custpage_tranid="';
			var rejectLink = "window.open('" + "/app/site/hosting/scriptlet.nl?script=111&deploy=1&compid=1246650&custpage_tranid=" + nlapiGetRecordId()+"','_self');";


			var rejectButton = form.addButton('custpage_rejectbutton', 'Reject', rejectLink);

		} //if

		// Version:		1.0.3 - 30 April 2013 - Amended - Added Approve window which is link to the suitelet and that will update the approval note field
		// if stage == pending supervisor approval (3) and the user is next approver ( second approver), 
		if (stage == '3' && ( user == nextApprover))
		{

			//var rejectLink = '"https://system.sandbox.netsuite.com/app/site/hosting/scriptlet.nl?script=111&deploy=1&custpage_tranid="';
			var approveLink = "window.open('" + "/app/site/hosting/scriptlet.nl?script=116&deploy=1&compid=1246650&custpage_tranid=" + nlapiGetRecordId()+"','_self');";


			var approveButton = form.addButton('custpage_approvebutton', 'Approve', approveLink);

		} //if




		if (UserDeptID == 1015) //Aepona PR Approver
		{

			/*			//var addnoteurl = "window.open('"+"/app/crm/common/note.nl?l=T&refresh=usernotes&perm=TRAN_PURCHORD&transaction="+ nlapiGetRecordId()+"');";
			var addnoteurl = "window.open('"+"/app/site/hosting/scriptlet.nl?script=85&deploy=1&compid=1246650&TID="+ nlapiGetRecordId()+"');";
			var printBtn = form.addButton('custpage_addnote', 'Add A Note', addnoteurl);
			 */
		}

		if (UserDeptID == 1000) //Belfast A/P Clerk	
			/*			{

			var printsuppliercopy = "show_preview("+ nlapiGetRecordId()+")";	
			var printBtn = form.addButton('custpage_printsuppliercopy', 'Print Supplier Copy', printsuppliercopy);

            var printBtn = form.addButton('custpage_printaeponacopy', 'Print Aepona Copy', 'printAeponaCopy');

            var enterBillurl = "window.open('"+"/app/accounting/transactions/vendbill.nl?transform=purchord&e=T&memdoc=0&id="+ nlapiGetRecordId()+"');";
            var printBtn = form.addButton('custpage_enterbill', 'Enter Bill', enterBillurl);

            var printBtn = form.addButton('custpage_markbilled', 'Mark Fully Billed', 'markFullyBilled');

            var sendmethod = nlapiGetFieldText('custbody_suppliersendmethod');
            var sendviaselected = ''
	            if (sendmethod == 'EMAIL')
	            	{
		            	//sendviaselected = "send_email("+ nlapiGetRecordId()+")";
		            	sendviaselected = "window.open('"+"/app/site/hosting/scriptlet.nl?script=67&deploy=1&compid=1246650&TID="+ nlapiGetRecordId()+"&To="+ nlapiGetFieldValue('custbody_prsuppliercontactemail')+"&Cc="+ nlapiGetFieldValue('custbody_pr_employeeemail')+"&Subject="+ nlapiGetFieldValue('tranid')+"')";
	            	}
	            	else
	            	{
		            	sendviaselected = "show_preview("+ nlapiGetRecordId()+")";
	            	}

	           	var printBtn = form.addButton('custpage_sendviaselectedmethod', 'Send Via Selected Method', sendviaselected);
			}
			 */
			return true;
	}
	catch(e)
	{
		nlapiLogExecution('error', 'beforeLoad', e.message);
	}
} //function


/**
 * @param type
 * @param form
 */
function createButtons(type,form)
{
	try
	{


		var onclickScript = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=ORD&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_printsuppliercopy', 'Print Supplier Copy', onclickScript);

		var onclickScript2 = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=PIN&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_printaeponacopy', 'Print Aepona Note', onclickScript2);

		var onclickScript3 = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=PIN&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_enterbill', 'Enter Bill', onclickScript3);

		var onclickScript4 = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=PIN&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_markbilled', 'Mark Fully Billed', onclickScript4);

		var onclickScript5 = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=PIN&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_sendviaselectedmethod', 'Send Via Selected Method', onclickScript5);

		var onclickScript6 = "window.open('" + nlapiResolveURL('SUITELET', 2, 1) + "&custparam_reptype=PIN&custparam_soid=" + nlapiGetRecordId() + "');";
		var printBtn = form.addButton('custBtn_addnote', 'Add A Note', onclickScript6);
	}
	catch(e)
	{
		nlapiLogExecution('error', 'createButtons', e.message);
	}
}


///**
//* 
//*/
//function test()
//{
//alert('hello');
//}
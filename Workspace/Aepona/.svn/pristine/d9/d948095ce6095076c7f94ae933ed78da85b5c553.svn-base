/*************************************************************************************
 * Name:		pr2_editContactSuitlet.js
 * Script Type:	Suitlet
 *
 * Version:		1.0.0                     first relase - ???
 * Version:		1.0.1   - 31/05/20013   - copied script from netsuite and created in SVN.- SA
 *
 * Author:		[FHL]
 * 
 * Purpose:		clientscript calls this suitlet, when creating PR, if issue to method and the populated information doesnot match then suitlet pop ups to update the details. 
 * 
 * Script: 		customscript_pr_editcontact    
 * Deploy: 		customdeploy_pr_editcontact
 * 
 * Notes:		[todo - deployment details i.e. form associated etc]
 * 
 * Library: 	Libary.js
 *************************************************************************************/
function updateContact(request,response)
{
	if ( request.getMethod() == 'GET' )
	{
		var ContactID = request.getParameter('CID');
		var SupplierID = request.getParameter('SID');
		var RequestedField = request.getParameter('UpdateField');
		var ContactName = nlapiLookupField('contact', ContactID, 'entityid');
		var ContactEmail = nlapiLookupField('contact', ContactID, 'email');
		var ContactPhone = nlapiLookupField('contact', ContactID, 'phone');
		var ContactFax = nlapiLookupField('contact', ContactID, 'fax');
		var SupplierName = nlapiLookupField('vendor', SupplierID, 'entityid');
		var Subsidiary = nlapiLookupField('vendor', SupplierID, 'subsidiary');
		var SubsidiaryCountry = nlapiLookupField('subsidiary', Subsidiary, 'country');
		var billaddr1 = nlapiLookupField('contact', ContactID, 'billaddress1');
		var billaddr2 = nlapiLookupField('contact', ContactID, 'billaddress2');
		var billaddr3 = nlapiLookupField('contact', ContactID, 'billaddress3');
		var billcity = nlapiLookupField('contact', ContactID, 'billcity');
		var billstate = nlapiLookupField('contact', ContactID, 'billstate');
		var billzip = nlapiLookupField('contact', ContactID, 'billzipcode');
		var billcountry = nlapiLookupField('contact', ContactID, 'billcountry');

		var Contactform = nlapiCreateForm("Contact");
		var headergroup = Contactform.addFieldGroup( 'headerfieldgroup', 'Contact');
		var detailsgroup = Contactform.addFieldGroup( 'detailsfieldgroup', 'Email | Phone | Fax');
		var addressgroup = Contactform.addFieldGroup( 'addressfieldgroup', 'Address');
		var frmContactID = Contactform.addField('custpage_contactid', 'text', 'Contact ID', null, 'headerfieldgroup').setDefaultValue(ContactID);
		//custpage_contactid.setDisplayType('inline');
		var frmContactName = Contactform.addField('custpage_contactname', 'text', 'Contact', null, 'headerfieldgroup').setDefaultValue(ContactName);
		var frmSupplierID = Contactform.addField('custpage_supplierid', 'text', 'Supplier ID', null, 'headerfieldgroup').setDefaultValue(SupplierID);
		//frmSupplierID.setDisplayType('inline');
		var frmSupplierName = Contactform.addField('custpage_suppliername', 'text', 'Supplier', null, 'headerfieldgroup').setDefaultValue(SupplierName);
		//frmSupplierName.setDisplayType('inline');
		var frmConatctEmail = Contactform.addField('custpage_contactemail', 'email', 'E Mail', null, 'detailsfieldgroup').setDefaultValue(ContactEmail);
		var frmContactPhone = Contactform.addField('custpage_contactphone', 'phone', 'Phone', null, 'detailsfieldgroup').setDefaultValue(ContactPhone);
		var frmContactFax = Contactform.addField('custpage_contactfax', 'phone', 'Fax', null, 'detailsfieldgroup').setDefaultValue(ContactFax);
		var frmAddLabel = Contactform.addField('custpage_addlabel', 'text', 'Label', null, 'addressfieldgroup');
		var frmAddAttention = Contactform.addField('custpage_addattention', 'text', 'Attention', null, 'addressfieldgroup');
		var frmAddAddressee = Contactform.addField('custpage_addaddressee', 'text', 'Addressee', null, 'addressfieldgroup').setDefaultValue(ContactName);
		var frmAddPhone = Contactform.addField('custpage_addphone', 'phone', 'Phone', null, 'addressfieldgroup').setDefaultValue(ContactPhone);
		var frmAdd1 = Contactform.addField('custpage_addaddress1', 'text', 'Address 1', null, 'addressfieldgroup').setDefaultValue(billaddr1);
		var frmAdd2 = Contactform.addField('custpage_addaddress2', 'text', 'Address 2', null, 'addressfieldgroup').setDefaultValue(billaddr2);
		var frmAdd3 = Contactform.addField('custpage_addaddress3', 'text', 'Address 3', null, 'addressfieldgroup').setDefaultValue(billaddr3);
		var frmAddCity = Contactform.addField('custpage_addcity', 'text', 'City', null, 'addressfieldgroup').setDefaultValue(billcity);
		var frmAddCSP = Contactform.addField('custpage_addcsp', 'text', 'County/State/Province', null, 'addressfieldgroup').setDefaultValue(billstate);
		var frmAddPC = Contactform.addField('custpage_addpostcode', 'text', 'Post Code', null, 'addressfieldgroup').setDefaultValue(billzip);
		var frmAddCountry = Contactform.addField('custpage_addcountry', 'select', 'Country', null, 'addressfieldgroup');


		var countrySearchColumns = new Array();

		countrySearchColumns[0] = new nlobjSearchColumn('name');
		countrySearchColumns[1] = new nlobjSearchColumn('internalid');
		countrySearchColumns[2] = new nlobjSearchColumn('custrecord_matchid');

		var countrySearchResults = nlapiSearchRecord('customrecord_pr_countires', null, null, countrySearchColumns);
		nlapiLogExecution('DEBUG', 'countrySearchResults', countrySearchResults.length);

		if (countrySearchResults != null)
		{                                              

			for (var i = 0; i < countrySearchResults.length; i++)
			{ 
				frmAddCountry.addSelectOption(countrySearchResults[i].getValue(countrySearchColumns[2]),countrySearchResults[i].getValue(countrySearchColumns[0]));
			}         
		}
		if (billcountry == '' || billcountry == null)
		{
			frmAddCountry.setDefaultValue(SubsidiaryCountry);						
		}
		else
		{
			frmAddCountry.setDefaultValue(billcountry);
		}


		Contactform.addSubmitButton('Update Details');

		response.writePage(Contactform);	
	}	

	else
	{			
		var SupplierID = request.getParameter('custpage_supplierid');
		var ContactID = request.getParameter('custpage_contactid');
		var ContactEmail = request.getParameter('custpage_contactemail');
		var ContactPhone = request.getParameter('custpage_contactphone');
		var ContactFax = request.getParameter('custpage_contactfax');
		var AddLabel = request.getParameter('custpage_addlabel');
		var AddAttention = request.getParameter('custpage_addattention');
		var AddAddressee = request.getParameter('custpage_addaddressee');
		var AddPhone = request.getParameter('custpage_addphone');
		var Add1 = '';
		var Add2 = '';
		var Add3 = '';
		var AddCity = '';
		var AddCSP = '';
		var AddPC = '';
		var AddCountry = '';

		Add1 = request.getParameter('custpage_addaddress1');
		Add2 = request.getParameter('custpage_addaddress2');
		Add3 = request.getParameter('custpage_addaddress3');
		AddCity = request.getParameter('custpage_addcity');
		AddCSP = request.getParameter('custpage_addcsp');
		AddPC = request.getParameter('custpage_addpostcode');
		AddCountry = request.getParameter('custpage_addcountry');

		var AddressTxt = '';

		if (Add1.length > 0)
		{
			AddressTxt+=Add1+'\n';
		}
		if (Add2.length > 0)
		{
			AddressTxt+=Add2+'\n';
		}
		if (Add3.length > 0)
		{
			AddressTxt+=Add3+'\n';
		}
		if (AddCity.length > 0)
		{
			AddressTxt+=AddCity+'\n';
		}
		if (AddCSP.length > 0)
		{
			AddressTxt+=AddCSP+'\n';
		}
		if (AddPC.length > 0)
		{
			AddressTxt+=AddPC+'\n';
		}
		if (AddCountry.length > 0)
		{
			AddressTxt+=AddCountry;
		}


		var COrecord = nlapiLoadRecord('contact', ContactID);
		COrecord.setFieldValue('email', ContactEmail);
		COrecord.setFieldValue('phone', ContactPhone);
		COrecord.setFieldValue('fax', ContactFax);
		COrecord.setFieldValue('shipaddr1', Add1);
		COrecord.setFieldValue('shipaddr2', Add2);
		COrecord.setFieldValue('shipaddr3', Add3);
		COrecord.setFieldValue('shipcity', AddCity);
		COrecord.setFieldValue('shipstate', AddCSP);
		COrecord.setFieldValue('shipzip', AddPC);
		COrecord.setFieldValue('shipcountry', AddCountry);

		//COrecord.selectNewLineItem('addressbook');
		//COrecord.setCurrentLineItemValue('addressbook','attention', AddAttention);
		//COrecord.setCurrentLineItemValue('addressbook','label', AddLabel);
		//COrecord.setCurrentLineItemValue('addressbook','adressee', AddAddressee);
		//COrecord.setCurrentLineItemValue('addressbook','addr1', Add1);
		//COrecord.setCurrentLineItemValue('addressbook','addr2', Add2);
		//COrecord.setCurrentLineItemValue('addressbook','addr3', Add3);
		//COrecord.setCurrentLineItemValue('addressbook','city', AddCity);
		//COrecord.setCurrentLineItemValue('addressbook','state', AddCSP);
		//COrecord.setCurrentLineItemValue('addressbook','zip', AddPC);
		//COrecord.setCurrentLineItemValue('addressbook','country', 'GB');
		//COrecord.setCurrentLineItemValue('addressbook','defaultbilling', 'T');
		//COrecord.setCurrentLineItemValue('addressbook','defaultshipping', 'T');
		//COrecord.commitLineItem('addressbook');
		var COid = nlapiSubmitRecord(COrecord);

		AddressTxt = escapeString(AddressTxt);	

		var scripthtml = '<html><script>';	

		scripthtml+='window.opener.nlapiSetFieldValue("custbody_pr_contact_email", "'+ContactEmail+'");';
		scripthtml+='window.opener.nlapiSetFieldValue("custbody_pr_contact_phone", "'+ContactPhone+'");';
		scripthtml+='window.opener.nlapiSetFieldValue("custbody_pr_contact_fax", "'+ContactFax+'");';
		scripthtml+='window.opener.nlapiSetFieldValue("custbody_prsuppliercontactaddress", "'+AddressTxt+'");';
		scripthtml+='window.close();';
		scripthtml+='</script></html>';

		response.write(scripthtml);

	}

}

function escapeString(str)
{

	str=str.replace(/\n/g,'\\n');
	str=str.replace(/\r/g,'');

	return str;
}



function reduceString(str)
{
	str=str.replace(/\n/g,' ');
	str=str.replace(/\r/g,'');

	return str;
}
